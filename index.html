<!--
  Product Sales Report Viewer

  This page lets you upload an Excel report (xlsx/xls) and immediately
  see the top and bottom three products in each category. For the
  Flower category, it further breaks down the results by weight.

  It searches for the header row by looking for a column named
  "ProductName" (caseâ€‘insensitive, ignoring spaces), so reports with
  introductory lines should still work. Required columns are
  Category, ProductName, QuantitySold, and NetSales (or GrossSales).
-->
<!DOCTYPE html>
<html lang="en">
<head><link rel="icon" type="image/png" href="favicon1.png"></head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Sales Report Viewer</title>
  <!-- Load SheetJS from the official CDN. If this line fails to load (e.g. due to network restrictions), the page will not be able to parse XLSX files. -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Modern dark theme styling */
    body {
      margin: 0;
      padding: 2rem;
      font-family: Arial, Helvetica, sans-serif;
      background: #121212;
      color: #e0e0e0;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      color: #fff;
    }
    .upload-container {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    label {
      font-weight: bold;
      font-size: 1rem;
    }
    input[type=file] {
      padding: 0.5rem;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 0.9rem;
      background: #1e1e1e;
      color: #e0e0e0;
    }
    .category-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border-radius: 8px;
      background: #1f1f1f;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    .category-section h2 {
      margin-top: 0;
      font-size: 1.5rem;
      border-bottom: 2px solid #333;
      padding-bottom: 0.5rem;
      color: #90caf9;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .results-table th,
    .results-table td {
      padding: 0.6rem 0.7rem;
      border-bottom: 1px solid #333;
      text-align: left;
    }
    .results-table th {
      background-color: #263238;
      font-weight: bold;
      color: #90caf9;
    }
    .results-table tbody tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    .subheading {
      margin-top: 1rem;
      font-weight: bold;
      color: #80cbc4;
    }
    @media (max-width: 600px) {
      .results-table thead {
        display: none;
      }
      .results-table tr {
        display: block;
        margin-bottom: 0.6rem;
      }
      .results-table td {
        display: flex;
        justify-content: space-between;
        padding: 0.4rem;
        border-bottom: none;
      }
      .results-table td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #90caf9;
        margin-right: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <h1>Product Sales Report Viewer</h1>
  <div class="upload-container">
    <label for="fileInput">Upload sales report:</label>
    <input type="file" id="fileInput" accept=".xlsx, .xls" />
  </div>
  <div id="results"></div>

  <script>
    // Group helper
    function groupBy(arr, keyFunc) {
      const map = new Map();
      arr.forEach(item => {
        const key = keyFunc(item);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      });
      return map;
    }
    // Determine weight group for flower
    function getWeightGroup(name) {
      const lower = String(name || '').toLowerCase();
      if (/(28g|28 g|ounce|1\s*oz|1oz|2[ ]?8[ ]?g)/.test(lower)) return 'ounce';
      if (/(14g|14 g|half\s*ounce|half\s*oz|1\/2\s*oz|1\s*2\s*oz)/.test(lower)) return '14gs';
      if (/(7g|7 g|quarter|quarter\s*oz|1\/4\s*oz)/.test(lower)) return '7gs';
      if (/(3\.5g|3\.5 g|3\.5|3 1\/2 g|eighth)/.test(lower)) return '3.5g';
      return 'other';
    }
    // Format currency
    function formatCurrency(value) {
      return value.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    document.getElementById('fileInput').addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type:'array' });
          // choose sheet
          let sheet = workbook.Sheets['Report'] || workbook.Sheets[workbook.SheetNames[0]];
          if (!sheet) throw new Error('No sheets found');
          const raw = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
          if (!raw || raw.length === 0) throw new Error('Empty sheet');
          // locate header row by normalizing cells and matching 'productname'
          let headerIndex = -1;
          for (let i=0; i<Math.min(raw.length, 40); i++) {
            const row = raw[i] || [];
            const found = row.some(cell => String(cell).replace(/\s+/g,'').toLowerCase() === 'productname');
            if (found) { headerIndex = i; break; }
          }
          if (headerIndex === -1) throw new Error('Header row not found (looking for ProductName column)');
          const headerRow = raw[headerIndex].map(col => String(col).trim());
          const dataRows = raw.slice(headerIndex + 1).filter(row => row.some(cell => cell !== '' && cell != null));
          const records = dataRows.map(row => {
            const obj = {};
            headerRow.forEach((col, idx) => { obj[col] = row[idx]; });
            return obj;
          });
          // resolve keys ignoring spaces and case
          function resolveKey(possible) {
            for (const name of possible) {
              const target = name.replace(/\s+/g,'').toLowerCase();
              for (const h of headerRow) {
                if (String(h).replace(/\s+/g,'').toLowerCase() === target) return h;
              }
            }
            return null;
          }
          const catKey = resolveKey(['Category']);
          const productKey = resolveKey(['ProductName','Product Name']);
          const qtyKey = resolveKey(['QuantitySold','Quantity Sold']);
          const salesKey = resolveKey(['NetSales','Net Sales','GrossSales','Gross Sales']);
          if (!catKey || !productKey || !qtyKey || !salesKey) {
            throw new Error('Required columns missing: Category, ProductName, QuantitySold, NetSales');
          }
          // filter records
          // Filter out rows missing category/product and exclude any product name containing "SAMPLE" (case-insensitive)
          const valid = records.filter(r => {
            const hasCat = !!r[catKey];
            const hasProd = !!r[productKey];
            if (!hasCat || !hasProd) return false;
            const name = String(r[productKey] || '').toLowerCase();
            return !name.includes('sample');
          });
          const categoryMap = groupBy(valid, r => r[catKey]);
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '';
          categoryMap.forEach((items, category) => {
            const productMap = groupBy(items, r => r[productKey]);
            const aggregates = [];
            productMap.forEach((rows, name) => {
              let q=0, s=0;
              rows.forEach(r => { q += Number(r[qtyKey] || 0); s += Number(r[salesKey] || 0); });
              aggregates.push({ name, q, s });
            });
            const sorted = aggregates.slice().sort((a,b) => b.q - a.q);
            const top = sorted.slice(0,3);
            const bottom = sorted.slice(-3);
            const section = document.createElement('div');
            section.className = 'category-section';
            const h2 = document.createElement('h2');
            h2.textContent = category;
            section.appendChild(h2);
            function buildTable(arr, title) {
              const sub = document.createElement('div'); sub.className = 'subheading'; sub.textContent = title; section.appendChild(sub);
              const table = document.createElement('table'); table.className = 'results-table';
              const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Product Name</th><th>Total Sold</th><th>Total Sales</th></tr>'; table.appendChild(thead);
              const tbody = document.createElement('tbody');
              arr.forEach(item => {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td'); td1.textContent = item.name; td1.setAttribute('data-label','Product Name');
                const td2 = document.createElement('td'); td2.textContent = item.q; td2.setAttribute('data-label','Total Sold');
                const td3 = document.createElement('td'); td3.textContent = formatCurrency(item.s); td3.setAttribute('data-label','Total Sales');
                tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                tbody.appendChild(tr);
              });
              table.appendChild(tbody);
              section.appendChild(table);
            }
            buildTable(top, 'Top 3 Products');
            buildTable(bottom, 'Bottom 3 Products');
            if (String(category).toLowerCase() === 'flower') {
              const weightMap = new Map();
              items.forEach(r => {
                const group = getWeightGroup(r[productKey]);
                if (!weightMap.has(group)) weightMap.set(group, []);
                weightMap.get(group).push(r);
              });
              ['ounce','14gs','7gs','3.5g'].forEach(g => {
                const list = weightMap.get(g) || [];
                if (!list.length) return;
                const wgProductMap = groupBy(list, r => r[productKey]);
                const agg=[];
                wgProductMap.forEach((rows,name) => {
                  let tq=0,ts=0;
                  rows.forEach(r => { tq+=Number(r[qtyKey]||0); ts+=Number(r[salesKey]||0); });
                  agg.push({ name, q:tq, s:ts });
                });
                const sortedW = agg.slice().sort((a,b) => b.q - a.q);
                const wgTop = sortedW.slice(0,3);
                const wgBottom = sortedW.slice(-3);
                buildTable(wgTop, g.toUpperCase() + ' - Top 3 Products');
                buildTable(wgBottom, g.toUpperCase() + ' - Bottom 3 Products');
              });
            }
            resultsDiv.appendChild(section);
          });
        } catch(err) {
          console.error(err);
          alert('Error: ' + (err && err.message ? err.message : err));
        }
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
